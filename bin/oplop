#!/usr/bin/env ruby
oplop_dir = File.expand_path(File.join(File.dirname(__FILE__), '..', 'lib'))
$LOAD_PATH.unshift(oplop_dir) unless $LOAD_PATH.include?(oplop_dir)
require 'oplop'
require 'oplop/cli'
require 'highline/import'


if ARGV.first =~ /\-help|\?/ or ARGV.empty?
  puts Oplop::Cli.help
  exit 0
end

new_or_label = ARGV.shift
mode = :query

label = if new_or_label =~ /\-new/
          mode = :new
          ARGV.shift || ""
        else
          new_or_label
        end

if label.empty?
  puts "!! You need to pass in a label!"
  exit 2
end


case mode
when :query
  master = ask("Enter your master password: ") { |q| q.echo = "*" }
when :new
  master = ask("Enter your master password: ") { |q| q.echo = "*" }
  master_confirm = ask("Enter your master password (again): ") { |q| q.echo = "*" }
  if (master != master_confirm)
    puts "!! Your master and confirm don't match!"
    exit 2
  end
end

password = Oplop.password(:label => label, :master => master)

puts "\n    Password for #{label}:\t#{password}\n\n"

if Oplop::Cli.copy_to_clipboard(password)
  print "This has been copied to your clipboard.\n"
end
